// Generated by CoffeeScript 1.6.1
(function() {
  var InMemoryTweetCounts, LatLon, RedisTweetCounts, Stream, TweetCountsFactory, app, express, port, stream, tweetCounts, twit, twitter, util,
    _this = this;

  express = require("express");

  app = express();

  app.use(express.logger());

  util = require('util');

  twitter = require('twitter');

  twit = new twitter({
    consumer_key: 'mCp0qZ0zGGcvA9ZKVo7xQ',
    consumer_secret: 'X1Z4FaK8Hv68ZoTUCmiRjDy6IP5d5n7OHYwC6es4A',
    access_token_key: '11510772-MZIWUADlvY7A9Cbz6kKpqbuRM7EfWrdskAnXNpxpE',
    access_token_secret: process.env['TWITTER_ACCESS_TOKEN_SECRET']
  });

  LatLon = (function() {

    function LatLon(lat, lon) {
      this.latitude = lat;
      this.longitude = lon;
    }

    LatLon.prototype.toId = function() {
      return "" + this.latitude + "," + this.longitude;
    };

    LatLon.fromId = function(id) {
      var latS, lonS, _ref;
      _ref = id.split(","), latS = _ref[0], lonS = _ref[1];
      return new LatLon(parseFloat(latS), parseFloat(lonS));
    };

    return LatLon;

  })();

  InMemoryTweetCounts = (function() {

    function InMemoryTweetCounts() {
      this.total = 0;
      this.map = {};
    }

    InMemoryTweetCounts.prototype.add = function(latLon) {
      var count, id;
      this.total++;
      id = latLon.toId();
      count = this.map[id];
      if (count != null) {
        return this.map[id] = count + 1;
      } else {
        return this.map[id] = 1;
      }
    };

    InMemoryTweetCounts.prototype.dump = function(callback) {
      var count, id;
      return callback({
        'total': this.total,
        'counts': (function() {
          var _ref, _results;
          _ref = this.map;
          _results = [];
          for (id in _ref) {
            count = _ref[id];
            _results.push({
              lat_lon: LatLon.fromId(id),
              count: count
            });
          }
          return _results;
        }).call(this)
      });
    };

    return InMemoryTweetCounts;

  })();

  RedisTweetCounts = (function() {

    function RedisTweetCounts(redis) {
      var _this = this;
      this.redis = redis;
      this.incKey = function(key) {
        return RedisTweetCounts.prototype.incKey.apply(_this, arguments);
      };
      this.prefix = "latLon.";
    }

    RedisTweetCounts.prototype.add = function(latLon) {
      this.incKey("total");
      return this.incKey(this.latLonFullId(latLon));
    };

    RedisTweetCounts.prototype.latLonFullId = function(latLon) {
      return "" + this.prefix + (latLon.toId());
    };

    RedisTweetCounts.prototype.incKey = function(key) {
      return this.redis.incr(key);
    };

    RedisTweetCounts.prototype.dump = function(callback) {
      var _this = this;
      return this.redis.get("total", function(err, totalBuffer) {
        var total;
        total = parseInt(totalBuffer.toString());
        return _this.redis.keys("" + _this.prefix + "*", function(err, fullIds) {
          var counts, fullId, _i, _len, _results;
          counts = [];
          _results = [];
          for (_i = 0, _len = fullIds.length; _i < _len; _i++) {
            fullId = fullIds[_i];
            _results.push((function(fullId) {
              return _this.redis.get(fullId, function(err, countBuffer) {
                var count, entry, id;
                id = fullId.toString().substring(_this.prefix.length);
                count = parseInt(countBuffer.toString());
                entry = {
                  lat_lon: LatLon.fromId(id),
                  count: count
                };
                counts.push(entry);
                if (fullIds.length === counts.length) {
                  return callback({
                    'total': total,
                    'counts': counts
                  });
                }
              });
            })(fullId));
          }
          return _results;
        });
      });
    };

    return RedisTweetCounts;

  })();

  TweetCountsFactory = (function() {

    function TweetCountsFactory() {}

    TweetCountsFactory.create = function() {
      var redis, rtg;
      try {
        if (process.env.REDISTOGO_URL) {
          console.log("Using Redis To Go");
          rtg = require("url").parse(process.env.REDISTOGO_URL);
          redis = require("redis").createClient(rtg.port, rtg.hostname);
          redis.auth(rtg.auth.split(":")[1]);
        } else {
          console.log("Using local Redis");
          redis = require("node-redis").createClient();
        }
        return new RedisTweetCounts(redis);
      } catch (e) {
        console.log("Falling back to in-memory counts");
        console.dir(e);
        return new InMemoryTweetCounts();
      }
    };

    return TweetCountsFactory;

  })();

  Stream = (function() {

    function Stream(tweetCounts, twitter, restartAfterSeconds) {
      var _this = this;
      this.tweetCounts = tweetCounts;
      this.twitter = twitter;
      if (restartAfterSeconds == null) {
        restartAfterSeconds = 30 * 60;
      }
      this.handleData = function(data) {
        return Stream.prototype.handleData.apply(_this, arguments);
      };
      this.restart = function() {
        return Stream.prototype.restart.apply(_this, arguments);
      };
      this.restartAfterMillis = restartAfterSeconds * 1000;
    }

    Stream.prototype.start = function() {
      var _this = this;
      return this.twitter.stream('statuses/sample', function(stream) {
        _this.stream = stream;
        console.log("Started listening for tweets, will restart after " + _this.restartAfterMillis + " millis");
        stream.on('data', _this.handleData);
        return setTimeout(_this.restart, _this.restartAfterMillis);
      });
    };

    Stream.prototype.restart = function() {
      if (this.stream != null) {
        console.log("Destroying stream");
        this.stream.destroy();
      }
      return this.start();
    };

    Stream.prototype.handleData = function(data) {
      if ((data.geo != null) && (data.geo.coordinates != null)) {
        return this.tweetCounts.add(new LatLon(data.geo.coordinates[0], data.geo.coordinates[1]));
      }
    };

    return Stream;

  })();

  tweetCounts = TweetCountsFactory.create();

  stream = new Stream(tweetCounts, twit);

  stream.start();

  app.all('*', function(req, resp, next) {
    resp.header("Access-Control-Allow-Origin", "*");
    resp.header("Access-Control-Allow-Headers", "X-Requested-With");
    return next();
  });

  app.get('/', function(req, resp) {
    return resp.send('Hello World!');
  });

  app.get('/counts.json', function(req, resp) {
    return tweetCounts.dump(function(dumped) {
      return resp.send(dumped);
    });
  });

  port = process.env.PORT || 5000;

  app.listen(port, function() {
    return console.log("Listening on " + port);
  });

}).call(this);
